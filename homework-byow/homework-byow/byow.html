<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰è¾¾-æ•°æ®ç»“æ„è¯¾ç¨‹è®¾è®¡ - BYOW - Build Your Own World</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #1e3c72;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        label {
            font-weight: bold;
            color: #555;
        }
        
        input[type="number"], input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 120px;
        }
        
        button {
            padding: 10px 20px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1e3c72;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .world-container {
            position: relative;
            border: 3px solid #1e3c72;
            border-radius: 10px;
            overflow: hidden;
            /* èƒŒæ™¯æ£‹ç›˜æ ¼çº¹ç† */
            background-image: 
                linear-gradient(45deg, #2a2a2a 25%, transparent 25%),
                linear-gradient(-45deg, #2a2a2a 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #2a2a2a 75%),
                linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 8px 8px;
            background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
            background-color: #ffb3d1;  /* æµ…ç²‰è‰²ä½œä¸ºåŸºç¡€è‰² */
            margin-bottom: 20px;
        }
        
        #worldCanvas {
            display: block;
            width: 100%;
            height: auto;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .info-box h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .info-box p {
            color: #666;
            line-height: 1.6;
        }
        
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border: 1px solid #333;
            border-radius: 3px;
        }
        
        /* HUDæ ·å¼ */
        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            z-index: 10;
            pointer-events: none;
        }
        
        .hud-item {
            margin: 5px 0;
        }
        
        .hud-label {
            color: #90EE90;
            font-weight: bold;
        }
        
        #worldCanvas {
            background: transparent;  /* CanvasèƒŒæ™¯é€æ˜ï¼Œæ˜¾ç¤ºå®¹å™¨èƒŒæ™¯çº¹ç† */
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ‰è¾¾-æ•°æ®ç»“æ„è¯¾ç¨‹è®¾è®¡ - ğŸŒ BYOW - Build Your Own World</h1>
        
        <div id="status" class="status info" style="display: none;"></div>
        
        <div class="control-panel">
            <div class="control-group">
                <label>ç§å­ (Seed):</label>
                <input type="number" id="seedInput" placeholder="éšæœº">
            </div>
            <div class="control-group">
                <label>å®½åº¦:</label>
                <input type="number" id="widthInput" value="80" min="20" max="100">
            </div>
            <div class="control-group">
                <label>é«˜åº¦:</label>
                <input type="number" id="heightInput" value="50" min="20" max="100">
            </div>
            <button onclick="generateWorld()">ç”Ÿæˆä¸–ç•Œ</button>
            <button onclick="loadWorld()">é‡æ–°åŠ è½½</button>
            <button onclick="saveGame()">ä¿å­˜æ¸¸æˆ</button>
            <button onclick="loadGame()">åŠ è½½æ¸¸æˆ</button>
        </div>
        
        <div class="world-container">
            <canvas id="worldCanvas"></canvas>
            <div class="hud" id="hud">
                <div class="hud-item">
                    <span class="hud-label">Tile:</span> <span id="tileInfo">-</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Position:</span> <span id="playerPos">-</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Seed:</span> <span id="currentSeed">-</span>
                </div>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="info-box">
                <h3>ä¸–ç•Œä¿¡æ¯</h3>
                <p id="worldInfo">ç­‰å¾…ç”Ÿæˆä¸–ç•Œ...</p>
            </div>
            <div class="info-box">
                <h3>æˆ¿é—´ç»Ÿè®¡</h3>
                <p id="roomStats">-</p>
            </div>
            <div class="info-box">
                <h3>èµ°å»Šç»Ÿè®¡</h3>
                <p id="corridorStats">-</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8082';
        let currentWorld = null;
        let canvas = null;
        let ctx = null;
        const TILE_SIZE = 6;  // æ¯ä¸ªç“¦ç‰‡çš„åƒç´ å¤§å°ï¼ˆç¨å¾®å¤§ä¸€ç‚¹ï¼Œç¡®ä¿'#'å’Œç‚¹æ¸…æ™°å¯è§ï¼‰
        
        // ç©å®¶çŠ¶æ€
        let playerX = -1;
        let playerY = -1;
        let inputSequence = '';  // è®°å½•è¾“å…¥åºåˆ—ï¼Œç”¨äºç¡®å®šæ€§
        let isGameStarted = false;

        // ç“¦ç‰‡é¢œè‰²æ˜ å°„ï¼ˆæ›´åƒåœ°ç‰¢é£æ ¼ï¼‰
        const TILE_COLORS = {
            0: '#000000',  // FLOOR (æˆ¿é—´åœ°æ¿) - é»‘è‰²
            1: '#404040',  // WALL (å¢™å£) - æ·±ç°è‰²ï¼ˆå¸¦çº¹ç†æ•ˆæœï¼‰
            2: '#000000',  // ROOM (æˆ¿é—´) - é»‘è‰²åœ°æ¿
            3: '#000000'   // CORRIDOR (èµ°å»Š) - é»‘è‰²åœ°æ¿
        };

        // åˆå§‹åŒ–
        window.onload = function() {
            canvas = document.getElementById('worldCanvas');
            ctx = canvas.getContext('2d');
            
            // è®¾ç½®é¼ æ ‡äº‹ä»¶
            setupMouseEvents();
            
            // è®¾ç½®é”®ç›˜äº‹ä»¶
            setupKeyboardEvents();
            
            // å°è¯•åŠ è½½ç°æœ‰ä¸–ç•Œ
            loadWorld();
        };
        
        // è®¾ç½®é¼ æ ‡äº‹ä»¶
        function setupMouseEvents() {
            canvas.addEventListener('mousemove', function(e) {
                if (!currentWorld) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) / TILE_SIZE);
                const y = Math.floor((e.clientY - rect.top) / TILE_SIZE);
                
                if (x >= 0 && x < currentWorld.width && y >= 0 && y < currentWorld.height) {
                    const tile = currentWorld.map[y][x];
                    let tileName = 'Unknown';
                    
                    if (tile === 1) {
                        tileName = 'Wall';
                    } else if (tile === 2) {
                        tileName = 'Room';
                    } else if (tile === 3) {
                        tileName = 'Corridor';
                    } else {
                        tileName = 'Empty';
                    }
                    
                    document.getElementById('tileInfo').textContent = tileName;
                }
            });
            
            canvas.addEventListener('mouseleave', function() {
                document.getElementById('tileInfo').textContent = '-';
            });
        }
        
        // è®¾ç½®é”®ç›˜äº‹ä»¶
        function setupKeyboardEvents() {
            document.addEventListener('keydown', function(e) {
                // å¦‚æœæŒ‰Sé”®ï¼Œå¼€å§‹æ¸¸æˆ
                if (e.key.toLowerCase() === 's' && !isGameStarted && currentWorld) {
                    startGame();
                    return;
                }
                
                // æ¸¸æˆå¼€å§‹åï¼Œå¤„ç†WASDç§»åŠ¨
                if (isGameStarted && currentWorld) {
                    const key = e.key.toLowerCase();
                    if (key === 'w' || key === 'a' || key === 's' || key === 'd') {
                        e.preventDefault();
                        movePlayer(key);
                    }
                }
            });
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (!currentWorld) return;
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯é€šè¡Œä½ç½®ï¼ˆæˆ¿é—´æˆ–èµ°å»Šï¼‰
            let found = false;
            for (let y = 0; y < currentWorld.height && !found; y++) {
                for (let x = 0; x < currentWorld.width && !found; x++) {
                    const tile = currentWorld.map[y][x];
                    if (tile === 2 || tile === 3) {  // æˆ¿é—´æˆ–èµ°å»Š
                        playerX = x;
                        playerY = y;
                        found = true;
                    }
                }
            }
            
            if (found) {
                isGameStarted = true;
                inputSequence = '';
                document.getElementById('playerPos').textContent = `(${playerX}, ${playerY})`;
                showStatus('æ¸¸æˆå¼€å§‹ï¼ä½¿ç”¨WASDé”®ç§»åŠ¨', 'success');
                renderWorld(currentWorld);
            }
        }
        
        // ç§»åŠ¨ç©å®¶
        function movePlayer(direction) {
            if (playerX < 0 || playerY < 0) return;
            
            let newX = playerX;
            let newY = playerY;
            
            // è®¡ç®—æ–°ä½ç½®
            if (direction === 'w') {
                newY--;
            } else if (direction === 's') {
                newY++;
            } else if (direction === 'a') {
                newX--;
            } else if (direction === 'd') {
                newX++;
            }
            
            // æ£€æŸ¥æ–°ä½ç½®æ˜¯å¦å¯é€šè¡Œ
            if (newX >= 0 && newX < currentWorld.width && 
                newY >= 0 && newY < currentWorld.height) {
                const tile = currentWorld.map[newY][newX];
                if (tile === 2 || tile === 3) {  // æˆ¿é—´æˆ–èµ°å»Š
                    playerX = newX;
                    playerY = newY;
                    inputSequence += direction;
                    renderWorld(currentWorld);
                    
                    // æ›´æ–°HUD
                    document.getElementById('playerPos').textContent = `(${playerX}, ${playerY})`;
                }
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // ç”Ÿæˆä¸–ç•Œ
        async function generateWorld() {
            const seed = document.getElementById('seedInput').value;
            const width = parseInt(document.getElementById('widthInput').value) || 80;
            const height = parseInt(document.getElementById('heightInput').value) || 50;
            
            showStatus('æ­£åœ¨ç”Ÿæˆä¸–ç•Œ...', 'info');
            
            try {
                let url = `${API_BASE}/api/generate?width=${width}&height=${height}`;
                if (seed) {
                    url += `&seed=${seed}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('ç”Ÿæˆä¸–ç•Œå¤±è´¥');
                }
                
                const world = await response.json();
                console.log('æ”¶åˆ°ä¸–ç•Œæ•°æ®:', world);
                currentWorld = world;
                
                // ç¡®ä¿mapæ•°æ®æ˜¯æ•°ç»„
                if (typeof world.map === 'string') {
                    try {
                        world.map = JSON.parse(world.map);
                    } catch (e) {
                        console.error('è§£æmapæ•°æ®å¤±è´¥:', e);
                    }
                }
                
                renderWorld(world);
                updateInfo(world);
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                isGameStarted = false;
                playerX = -1;
                playerY = -1;
                inputSequence = '';
                document.getElementById('currentSeed').textContent = world.seed;
                document.getElementById('playerPos').textContent = '-';
                showStatus(`ä¸–ç•Œç”ŸæˆæˆåŠŸï¼ç§å­: ${world.seed}ã€‚æŒ‰Sé”®å¼€å§‹æ¸¸æˆ`, 'success');
            } catch (error) {
                showStatus('ç”Ÿæˆä¸–ç•Œå¤±è´¥: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        // åŠ è½½ä¸–ç•Œ
        async function loadWorld() {
            showStatus('æ­£åœ¨åŠ è½½ä¸–ç•Œ...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/world`);
                if (!response.ok) {
                    throw new Error('åŠ è½½ä¸–ç•Œå¤±è´¥');
                }
                
                const world = await response.json();
                console.log('åŠ è½½ä¸–ç•Œæ•°æ®:', world);
                currentWorld = world;
                
                // ç¡®ä¿mapæ•°æ®æ˜¯æ•°ç»„
                if (typeof world.map === 'string') {
                    try {
                        world.map = JSON.parse(world.map);
                    } catch (e) {
                        console.error('è§£æmapæ•°æ®å¤±è´¥:', e);
                    }
                }
                
                renderWorld(world);
                updateInfo(world);
                isGameStarted = false;
                playerX = -1;
                playerY = -1;
                inputSequence = '';
                document.getElementById('currentSeed').textContent = world.seed;
                document.getElementById('playerPos').textContent = '-';
                showStatus('ä¸–ç•ŒåŠ è½½æˆåŠŸã€‚æŒ‰Sé”®å¼€å§‹æ¸¸æˆ', 'success');
            } catch (error) {
                showStatus('æ²¡æœ‰å·²ç”Ÿæˆçš„ä¸–ç•Œï¼Œè¯·å…ˆç”Ÿæˆä¸–ç•Œ', 'info');
                console.error('Error:', error);
            }
        }

        // æ¸²æŸ“ä¸–ç•Œ
        function renderWorld(world) {
            console.log('æ¸²æŸ“ä¸–ç•Œï¼Œæ•°æ®:', world);
            
            if (!world) {
                console.error('ä¸–ç•Œæ•°æ®ä¸ºç©º');
                return;
            }
            
            if (!world.map) {
                console.error('åœ°å›¾æ•°æ®ä¸å­˜åœ¨ï¼Œä¸–ç•Œå¯¹è±¡:', world);
                showStatus('åœ°å›¾æ•°æ®ç¼ºå¤±', 'error');
                return;
            }
            
            if (!canvas || !ctx) {
                console.error('Canvasæœªåˆå§‹åŒ–');
                return;
            }
            
            const width = world.width;
            const height = world.height;
            
            console.log(`ä¸–ç•Œå°ºå¯¸: ${width} x ${height}, åœ°å›¾æ•°æ®é•¿åº¦: ${world.map.length}`);
            
            // è®¾ç½®ç”»å¸ƒå¤§å°
            canvas.width = width * TILE_SIZE;
            canvas.height = height * TILE_SIZE;
            
            // ç»˜åˆ¶èƒŒæ™¯æ£‹ç›˜æ ¼çº¹ç†ï¼ˆæ·±ç°è‰²å’Œæµ…ç²‰è‰²äº¤æ›¿ï¼‰
            const bgColor1 = '#2a2a2a';  // æ·±ç°è‰²
            const bgColor2 = '#ffb3d1';  // æµ…ç²‰è‰²
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const isEven = (x + y) % 2 === 0;
                    ctx.fillStyle = isEven ? bgColor1 : bgColor2;
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
            
            // ç»˜åˆ¶åœ°å›¾ï¼ˆåƒç´ é£æ ¼ï¼Œæ¨¡ä»¿æ•™ç¨‹å›¾ï¼‰
            let drawnTiles = 0;
            let wallCount = 0, roomCount = 0, corridorCount = 0;
            
            // è®¾ç½®å­—ä½“ç”¨äºç»˜åˆ¶'#'ç¬¦å·ï¼ˆä½¿ç”¨ç­‰å®½å­—ä½“ï¼Œç¡®ä¿ç¬¦å·æ¸…æ™°ï¼‰
            ctx.font = `bold ${TILE_SIZE}px 'Courier New', monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            for (let y = 0; y < height; y++) {
                if (!world.map[y]) {
                    console.warn(`ç¬¬${y}è¡Œæ•°æ®ä¸å­˜åœ¨`);
                    continue;
                }
                for (let x = 0; x < width; x++) {
                    const tile = world.map[y][x];
                    
                    // åªç»˜åˆ¶æœ‰å†…å®¹çš„ç“¦ç‰‡ï¼Œæœªä½¿ç”¨çš„ç©ºé—´æ˜¾ç¤ºèƒŒæ™¯çº¹ç†
                    if (tile === 1) {
                        // å¢™å£ï¼šæ·±ç°è‰²èƒŒæ™¯ + ç²‰çº¢è‰²'#'ç¬¦å·
                        ctx.fillStyle = '#404040';  // æ·±ç°è‰²å¢™å£èƒŒæ™¯
                        ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        
                        // ç»˜åˆ¶'#'ç¬¦å·ï¼ˆç²‰çº¢è‰²ï¼Œæ›´æ˜æ˜¾ï¼‰
                        ctx.fillStyle = '#FF6B9D';  // ç²‰çº¢è‰²'#'
                        const centerX = x * TILE_SIZE + TILE_SIZE / 2;
                        const centerY = y * TILE_SIZE + TILE_SIZE / 2;
                        ctx.fillText('#', centerX, centerY);
                        
                        wallCount++;
                    } else if (tile === 2 || tile === 3) {
                        // åœ°æ¿ï¼šé»‘è‰²èƒŒæ™¯ + å¾ˆå°çš„æµ…ç»¿è‰²ç‚¹
                        ctx.fillStyle = '#000000';  // é»‘è‰²åœ°æ¿
                        ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        
                        // ç»˜åˆ¶å¾ˆå°çš„ç‚¹ï¼ˆæµ…ç»¿è‰²ï¼Œéå¸¸å°ï¼‰
                        ctx.fillStyle = '#90EE90';  // æµ…ç»¿è‰²ç‚¹
                        const dotX = x * TILE_SIZE + TILE_SIZE / 2;
                        const dotY = y * TILE_SIZE + TILE_SIZE / 2;
                        // ç»˜åˆ¶ä¸€ä¸ªéå¸¸å°çš„åœ†ç‚¹ï¼ˆåŠå¾„çº¦ä¸ºç“¦ç‰‡çš„1/6ï¼‰
                        ctx.beginPath();
                        ctx.arc(dotX, dotY, Math.max(0.5, TILE_SIZE / 6), 0, Math.PI * 2);
                        ctx.fill();
                        
                        if (tile === 2) roomCount++;
                        else corridorCount++;
                    }
                    // tile === 0 æˆ–æœªå®šä¹‰ï¼šä¸ç»˜åˆ¶ï¼Œæ˜¾ç¤ºèƒŒæ™¯çº¹ç†
                    
                    drawnTiles++;
                }
            }
            
            console.log(`å·²ç»˜åˆ¶ ${drawnTiles} ä¸ªç“¦ç‰‡ (å¢™å£:${wallCount}, æˆ¿é—´:${roomCount}, èµ°å»Š:${corridorCount})`);
            
            // ç»˜åˆ¶ç©å®¶ï¼ˆå¦‚æœæ¸¸æˆå·²å¼€å§‹ï¼‰
            if (isGameStarted && playerX >= 0 && playerY >= 0) {
                ctx.fillStyle = '#FFFF00';  // é»„è‰²
                ctx.font = `bold ${TILE_SIZE}px 'Courier New', monospace`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const playerCenterX = playerX * TILE_SIZE + TILE_SIZE / 2;
                const playerCenterY = playerY * TILE_SIZE + TILE_SIZE / 2;
                ctx.fillText('@', playerCenterX, playerCenterY);
            }
        }

        // æ›´æ–°ä¿¡æ¯é¢æ¿
        function updateInfo(world) {
            if (!world) return;
            
            // ä¸–ç•Œä¿¡æ¯
            document.getElementById('worldInfo').innerHTML = `
                <strong>ç§å­:</strong> ${world.seed}<br>
                <strong>å°ºå¯¸:</strong> ${world.width} Ã— ${world.height}<br>
                <strong>è¿é€šæ€§:</strong> ${world.roomCount > 0 ? 'âœ“ è¿é€š' : 'âœ— æœªè¿é€š'}
            `;
            
            // æˆ¿é—´ç»Ÿè®¡
            document.getElementById('roomStats').innerHTML = `
                <strong>æˆ¿é—´æ•°é‡:</strong> ${world.roomCount}<br>
                <strong>å¹³å‡å¤§å°:</strong> ${world.rooms && world.rooms.length > 0 
                    ? Math.round(world.rooms.reduce((sum, r) => sum + r.width * r.height, 0) / world.rooms.length)
                    : 0} ç“¦ç‰‡
            `;
            
            // èµ°å»Šç»Ÿè®¡
            document.getElementById('corridorStats').innerHTML = `
                <strong>èµ°å»Šæ•°é‡:</strong> ${world.corridorCount}<br>
                <strong>è½¬å¼¯èµ°å»Š:</strong> ${world.corridors 
                    ? world.corridors.filter(c => c.isTurning).length 
                    : 0}
            `;
        }

        // ä¿å­˜æ¸¸æˆ
        async function saveGame() {
            if (!currentWorld || !isGameStarted) {
                showStatus('è¯·å…ˆå¼€å§‹æ¸¸æˆ', 'error');
                return;
            }
            
            const saveData = {
                seed: currentWorld.seed,
                width: currentWorld.width,
                height: currentWorld.height,
                playerX: playerX,
                playerY: playerY,
                inputSequence: inputSequence
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(saveData)
                });
                
                if (response.ok) {
                    showStatus('æ¸¸æˆå·²ä¿å­˜', 'success');
                } else {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                showStatus('ä¿å­˜æ¸¸æˆå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½æ¸¸æˆ
        async function loadGame() {
            try {
                const response = await fetch(`${API_BASE}/api/load`);
                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }
                
                const saveData = await response.json();
                
                // é‡æ–°ç”Ÿæˆä¸–ç•Œï¼ˆä½¿ç”¨ç›¸åŒç§å­ï¼‰
                await generateWorldFromSeed(saveData.seed, saveData.width, saveData.height);
                
                // æ¢å¤ç©å®¶ä½ç½®å’Œè¾“å…¥åºåˆ—
                playerX = saveData.playerX;
                playerY = saveData.playerY;
                inputSequence = saveData.inputSequence;
                isGameStarted = true;
                
                // é‡æ–°æ‰§è¡Œè¾“å…¥åºåˆ—ï¼ˆç¡®ä¿ç¡®å®šæ€§ï¼‰
                for (let i = 0; i < inputSequence.length; i++) {
                    movePlayer(inputSequence[i]);
                }
                
                showStatus('æ¸¸æˆå·²åŠ è½½', 'success');
            } catch (error) {
                showStatus('åŠ è½½æ¸¸æˆå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ä»ç§å­ç”Ÿæˆä¸–ç•Œï¼ˆå†…éƒ¨å‡½æ•°ï¼‰
        async function generateWorldFromSeed(seed, width, height) {
            let url = `${API_BASE}/api/generate?width=${width}&height=${height}&seed=${seed}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('ç”Ÿæˆä¸–ç•Œå¤±è´¥');
            }
            const world = await response.json();
            currentWorld = world;
            if (typeof world.map === 'string') {
                try {
                    world.map = JSON.parse(world.map);
                } catch (e) {
                    console.error('è§£æmapæ•°æ®å¤±è´¥:', e);
                }
            }
            renderWorld(world);
            updateInfo(world);
            document.getElementById('currentSeed').textContent = world.seed;
        }
        
        // å¤„ç†é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                generateWorld();
            } else if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                loadWorld();
            }
        });
    </script>
</body>
</html>

